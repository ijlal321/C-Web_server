<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Client Approval UI</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; }
    .section { margin-bottom: 30px; }
    .client-list { border: 1px solid #ccc; padding: 10px; min-height: 60px; }
    .client { margin-bottom: 8px; }
    .approved { color: green; }
    .not-approved { color: red; }
    button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Client Approval Panel</h1>
  <div class="section">
    <h2>Not Approved Clients</h2>
    <div id="not-approved" class="client-list"></div>
  </div>
  <div class="section">
    <h2>Approved Clients</h2>
    <div id="approved" class="client-list"></div>
  </div>

  <script>
    // Store clients by public_id
    const clients = {};

    // Called from C when a new client is added
    window.AddClient = function(client) {
      // client: {public_id, private_id, approved, public_name}
      clients[client.public_id] = client;
      renderClients();
    };


    // Show feedback to user
    function showStatus(msg, isError) {
      let status = document.getElementById('status-msg');
      if (!status) {
        status = document.createElement('div');
        status.id = 'status-msg';
        document.body.insertBefore(status, document.body.firstChild);
      }
      status.textContent = msg;
      status.style.color = isError ? 'red' : 'green';
      setTimeout(() => { status.textContent = ''; }, 2000);
    }

    // Render both lists
    function renderClients() {
      const notApprovedDiv = document.getElementById('not-approved');
      const approvedDiv = document.getElementById('approved');
      notApprovedDiv.innerHTML = '';
      approvedDiv.innerHTML = '';

      Object.values(clients).forEach(client => {
        const div = document.createElement('div');
        div.className = 'client ' + (client.approved ? 'approved' : 'not-approved');
        div.textContent = `ID: ${client.public_id} | Name: ${client.public_name || ''}`;
        if (!client.approved) {
          const btn = document.createElement('button');
          btn.textContent = 'Approve';
          btn.disabled = false;
          btn.onclick = function() {
            btn.disabled = true;
            btn.textContent = 'Approving...';
            if (window.approve_client) {
              window.approve_client({ public_id: client.public_id })
                .then(success => {
                  if (success === true || success === 'true') {
                    client.approved = 1;
                    showStatus('Client approved!', false);
                    renderClients();
                  } else {
                    showStatus('Failed to approve client.', true);
                    btn.disabled = false;
                    btn.textContent = 'Approve';
                  }
                })
                .catch(err => {
                  showStatus('Error: ' + err, true);
                  btn.disabled = false;
                  btn.textContent = 'Approve';
                });
            } else {
              showStatus('approve_client function not available.', true);
              btn.disabled = false;
              btn.textContent = 'Approve';
            }
          };
          div.appendChild(btn);
          notApprovedDiv.appendChild(div);
        } else {
          approvedDiv.appendChild(div);
        }
      });
    }

    // Example: Add a test client (remove in production)
    // window.AddClient({public_id: 1, private_id: "abc", approved: 0, public_name: "Test Client"});

    // For webview2: expose approve_client to JS
    if (window.external && window.external.invoke) {
      window.approve_client = function(arg) {
        window.external.invoke(JSON.stringify({name: "approve_client", arg}));
      };
    }
  </script>
</body>
</html>