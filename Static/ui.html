<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Client Approval UI</title>
	<style>
		body { font-family: sans-serif; max-width: 800px; margin: auto; }
		.section { margin-bottom: 30px; }
		.client-list { border: 1px solid #ccc; padding: 10px; min-height: 60px; }
		.client { margin-bottom: 8px; }
		.approved { color: green; }
		.not-approved { color: red; }
		button { margin-left: 10px; }
		#status-msg { margin-bottom: 20px; }
	</style>
</head>
<body>
	<h1>Client Approval Panel</h1>
	<div id="status-msg"></div>

	<div class="section">
		<h2>Disapproved Clients</h2>
		<div id="disapproved" class="client-list"></div>
	</div>
	<div class="section">
		<h2>Approved Clients</h2>
		<div id="approved" class="client-list"></div>
	</div>

	<script>
		// Store clients by public_id
		const clients = {};

		function showStatus(msg, isError) {
			const status = document.getElementById('status-msg');
			status.textContent = msg;
			status.style.color = isError ? 'red' : 'green';
			if (msg) setTimeout(() => { status.textContent = ''; }, 2000);
		}

		function renderClients() {
			const approvedDiv = document.getElementById('approved');
			const disapprovedDiv = document.getElementById('disapproved');
			approvedDiv.innerHTML = '';
			disapprovedDiv.innerHTML = '';

			Object.values(clients).forEach(client => {
				const div = document.createElement('div');
				div.className = 'client ' + (client.approved ? 'approved' : 'disapproved');
				div.textContent = `ID: ${client.public_id} | Name: ${client.public_name || ''}`;
				div.style.cursor = 'pointer';
				if (client.approved) {
					div.title = 'Click to disapprove';
					div.onclick = function() {
						if (ws && ws.readyState === WebSocket.OPEN) {
							ws.send(JSON.stringify({ opcode: 6, data: { public_id: client.public_id } }));
							client.approved = 0;
							renderClients();
						}
					};
					approvedDiv.appendChild(div);
				} else {
					div.title = 'Click to approve';
					div.onclick = function() {
						if (ws && ws.readyState === WebSocket.OPEN) {
							ws.send(JSON.stringify({ opcode: 4, data: { public_id: client.public_id } }));
							client.approved = 1;
							renderClients();
						}
					};
					disapprovedDiv.appendChild(div);
				}
			});
		}

		// WebSocket logic
		let ws;
		function connectWS() {
			ws = new WebSocket('ws://localhost:8080/chat');
			ws.onopen = function() {
				showStatus('WebSocket connected', false);
				// Send initial message: opcode 1, data {}
				ws.send(JSON.stringify({ opcode: 1, data: {} }));
			};
			ws.onmessage = function(event) {
				try {
					const msg = JSON.parse(event.data);
					handleWSMessage(msg);
				} catch (e) {
					showStatus('Invalid message received', true);
				}
			};
			ws.onclose = function() {
				showStatus('WebSocket closed', true);
				// Optionally, try to reconnect after a delay
			};
			ws.onerror = function() {
				showStatus('WebSocket error', true);
			};
		}

		function handleWSMessage(msg) {
			if (!msg || typeof msg.opcode !== 'number') return;
			switch (msg.opcode) {
				case 3:
					// msg.data is an array of clients
					if (Array.isArray(msg.data)) {
						msg.data.forEach(c => {
							// Defensive: ensure required fields
							if (typeof c.public_id === 'number') {
								clients[c.public_id] = {
									public_id: c.public_id,
									private_id: c.private_id || '',
									public_name: c.public_name || '',
									approved: c.approved ? 1 : 0
								};
							}
						});
						renderClients();
					}
					break;
				// Room for other opcodes
				default:
					// Handle other opcodes as needed
					break;
			}
		}

		// Start WebSocket on page load
		window.onload = connectWS;
	</script>
</body>
</html>
